<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Listening</title>

  <!--明确非公开、非索引-->
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <meta name="referrer" content="no-referrer" />

  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:#0b0c10; color:#e8e8e8; }
    .wrap { max-width: 820px; margin: 40px auto; padding: 0 18px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 18px; }
    h1 { font-size: 18px; margin: 0 0 10px; font-weight: 600; }
    .note { font-size: 12px; opacity: .85; line-height: 1.6; margin-top: 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .col { flex: 1 1 240px; min-width: 220px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #fff;
      font-size: 13px;
      box-sizing: border-box;
    }
    textarea { height: 160px; resize: vertical; }
    button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button:active { transform: translateY(1px); }
    .small { font-size: 12px; opacity: .72; margin-top: 10px; }
    .hr { height: 1px; background: rgba(255,255,255,0.12); margin: 14px 0; }
    .hidden { display:none; }
    .err { margin-top:10px; font-size:12px; color:#ffb3b3; display:none; }
    code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 6px; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,0.16); background: rgba(255,255,255,0.06); font-size: 12px; opacity: .85; }
    a.link { color:#e8e8e8; text-decoration: underline; text-underline-offset: 3px; opacity: .9; }
    .muted { opacity: .7; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- GATE -->
    <div class="card" id="gate">
      <h1>Private Listening (Evaluation Only)</h1>
      <div class="note">
        <b>Private listening only.</b> For evaluation purposes.<br/>
        Not for distribution, reproduction, public sharing, or re-uploading.
      </div>

      <div class="row">
        <div class="col">
          <input id="pw" type="password" placeholder="Passcode" autocomplete="off" />
        </div>
        <div style="flex:0 0 auto">
          <button type="button" onclick="enter()">Enter</button>
        </div>
      </div>

      <div class="err" id="err">Passcode incorrect.</div>

      <div class="small muted">
        Tip: If you received a track list, enter the passcode first, then select a track code.
      </div>
    </div>

    <!-- CONTENT -->
    <div class="card hidden" id="content">
      <div class="row" style="align-items:baseline; justify-content:space-between;">
        <div>
          <h1 style="margin:0">Private Listening</h1>
          <div class="note" style="margin-top:6px">
            Library: <span class="pill" id="libName">—</span>
            <span class="muted"> &nbsp;|&nbsp; Mode: <span id="modeName">—</span></span>
          </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button type="button" onclick="lock()">Lock</button>
          <button type="button" onclick="resetNotes()">Clear notes</button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Track chooser -->
      <div class="row">
        <div class="col">
          <div class="note"><b>Select track</b> (dropdown)</div>
          <select id="trackSelect"></select>
          <div class="small muted">Changing selection will start playback.</div>
        </div>

        <div class="col">
          <div class="note"><b>Or type track code</b> and press Enter</div>
          <input id="trackInput" placeholder="e.g. 001 / A01 / B02" />
          <div class="small muted">You can copy/paste the code from the track list.</div>
        </div>
      </div>

      <!-- Player -->
      <div style="margin-top:12px">
        <div class="note"><b>Now playing</b>: <span id="nowPlaying" class="muted">—</span></div>
        <audio id="player" controls preload="none" controlsList="nodownload noplaybackrate"></audio>
        <div class="small muted" id="sourceHint">—</div>
      </div>

      <div class="hr"></div>

      <!-- Feedback -->
      <div>
        <div class="note">
          <b>Quick notes</b> (timestamps + one sentence).<br/>
          Press <b>T</b> to insert current timestamp. Press <b>Ctrl/Cmd + Enter</b> to copy all notes.
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:0 0 auto">
            <button type="button" onclick="insertTimestamp()">Insert current timestamp</button>
          </div>
          <div style="flex:0 0 auto">
            <button type="button" onclick="copyFB()">Copy feedback</button>
          </div>
          <div style="flex:0 0 auto">
            <button type="button" onclick="copyTrackLine()">Copy track line</button>
          </div>
        </div>

        <textarea id="fb" placeholder="Example:
0:42 - mood good, drum could be looser
1:12 - vocal phrasing great, add a bit more space
2:05 - consider repeating chorus once more
Credits/splits thoughts: ..."></textarea>

        <div class="small">
          Preferred feedback format: <code>mm:ss</code> + (arrangement / melody / mix / structure / credits).
        </div>
      </div>
    </div>

    <div class="small muted" style="margin-top:14px; text-align:center;">
      If you cannot play audio due to network conditions, please tell me — I will provide a local mirror link or a direct preview file.
    </div>

  </div>

<script>
/**
 * Multi-passcode, multi-library listening room
 * - Update only LIBRARIES to add/remove passcodes and tracks
 * - Each track can have: src (overseas), src_cn (China mirror, optional), duration (optional)
 *
 * SECURITY NOTE:
 * This is a lightweight access gate for evaluation use (not strong security).
 */

// ===== 1) CONFIG: passcode -> library =====
const LIBRARIES = {
  // Example general library (replace with yours)
  "123": {
    name: "General Preview Library",
    mode: "general",
    tracks: {
      "001": { title: "Working Title A", duration: "3:18", src: "https://goldisle.org/assets/audio/track_001.mp3", src_cn: "" },
      "002": { title: "Working Title B", duration: "2:47", src: "https://goldisle.org/assets/audio/track_002.mp3", src_cn: "" }
    }
  },

  // Example collaborator A library
  "A-7F3K": {
    name: "Library for Collaborator A",
    mode: "collab",
    tracks: {
      "A01": { title: "Project A – Demo 1", duration: "3:12", src: "https://goldisle.org/assets/audio/A01.mp3", src_cn: "" },
      "A02": { title: "Project A – Demo 2", duration: "2:05", src: "https://goldisle.org/assets/audio/A02.mp3", src_cn: "" }
    }
  },

  // Example collaborator B library
  "B-9Q2M": {
    name: "Library for Collaborator B",
    mode: "collab",
    tracks: {
      "B01": { title: "Project B – Sketch 1", duration: "1:55", src: "https://goldisle.org/assets/audio/B01.mp3", src_cn: "" }
    }
  }
};

// ===== 2) STATE =====
let ACTIVE_LIB = null;
let ACTIVE_PASS = null;
let ACTIVE_CODE = null;

// ===== 3) ELEMENTS =====
const gateEl = document.getElementById("gate");
const contentEl = document.getElementById("content");
const errEl = document.getElementById("err");
const pwEl = document.getElementById("pw");

const libNameEl = document.getElementById("libName");
const modeNameEl = document.getElementById("modeName");

const trackSelectEl = document.getElementById("trackSelect");
const trackInputEl = document.getElementById("trackInput");

const nowPlayingEl = document.getElementById("nowPlaying");
const sourceHintEl = document.getElementById("sourceHint");

const playerEl = document.getElementById("player");
const fbEl = document.getElementById("fb");

// ===== 4) UTIL =====
function pad2(n){ return String(n).padStart(2,'0'); }
function formatTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${pad2(s)}`;
}
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  el.value = el.value.slice(0, start) + text + el.value.slice(end);
  const pos = start + text.length;
  el.selectionStart = el.selectionEnd = pos;
  el.focus();
}
function firstTrackCode(lib){
  const keys = Object.keys(lib.tracks || {});
  return keys.length ? keys[0] : null;
}
function safeText(s){ return (s || "").replace(/\s+/g, " ").trim(); }

// ===== 5) GATE =====
function enter(){
  const pass = (pwEl.value || "").trim();
  const lib = LIBRARIES[pass];

  if (!lib) {
    errEl.style.display = "block";
    return;
  }

  ACTIVE_LIB = lib;
  ACTIVE_PASS = pass;

  errEl.style.display = "none";
  gateEl.classList.add("hidden");
  contentEl.classList.remove("hidden");

  libNameEl.textContent = lib.name || "—";
  modeNameEl.textContent = lib.mode || "—";

  renderTrackList();

  // Autoplay first track (optional): comment out if you prefer manual play
  const first = firstTrackCode(lib);
  if (first) {
    trackSelectEl.value = first;
    playByCode(first, {autoplay:true});
  }
}

function lock(){
  // reset state + UI
  ACTIVE_LIB = null;
  ACTIVE_PASS = null;
  ACTIVE_CODE = null;

  // stop audio
  try { playerEl.pause(); } catch(e) {}
  playerEl.removeAttribute("src");
  playerEl.load();

  // UI
  contentEl.classList.add("hidden");
  gateEl.classList.remove("hidden");
  pwEl.value = "";
  errEl.style.display = "none";
  nowPlayingEl.textContent = "—";
  sourceHintEl.textContent = "—";
  trackSelectEl.innerHTML = "";
  trackInputEl.value = "";
}

pwEl.addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") enter();
});

// ===== 6) TRACK LIST RENDER =====
function renderTrackList(){
  trackSelectEl.innerHTML = "";

  const entries = Object.entries(ACTIVE_LIB.tracks || {});
  // Sort codes to be stable
  entries.sort((a,b)=> a[0].localeCompare(b[0], undefined, {numeric:true, sensitivity:"base"}));

  for (const [code, t] of entries) {
    const opt = document.createElement("option");
    const dur = t.duration ? ` (${t.duration})` : "";
    opt.value = code;
    opt.textContent = `${code} — ${t.title || "Untitled"}${dur}`;
    trackSelectEl.appendChild(opt);
  }

  // if empty
  if (!entries.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No tracks in this library";
    trackSelectEl.appendChild(opt);
    trackSelectEl.disabled = true;
  } else {
    trackSelectEl.disabled = false;
  }
}

trackSelectEl.addEventListener("change", (e)=>{
  const code = e.target.value;
  if (code) playByCode(code, {autoplay:true});
});

trackInputEl.addEventListener("keydown", (e)=>{
  if (e.key === "Enter") {
    const code = (trackInputEl.value || "").trim();
    if (code) playByCode(code, {autoplay:true});
  }
});

// ===== 7) PLAYBACK (overseas + optional China mirror fallback) =====
function setPlayerSources(track){
  // We rebuild the <audio> element sources each time.
  // First: overseas src; Second: China mirror (optional).
  // Browser will fallback if first fails.
  playerEl.innerHTML = "";

  const srcMain = (track.src || "").trim();
  const srcCN = (track.src_cn || "").trim();

  if (srcMain) {
    const s1 = document.createElement("source");
    s1.src = srcMain;
    s1.type = "audio/mpeg";
    playerEl.appendChild(s1);
  }

  if (srcCN) {
    const s2 = document.createElement("source");
    s2.src = srcCN;
    s2.type = "audio/mpeg";
    playerEl.appendChild(s2);
  }

  sourceHintEl.textContent = srcCN
    ? "Source: overseas primary + China mirror fallback."
    : "Source: overseas primary. (China mirror not set for this track.)";
}

function playByCode(code, {autoplay=false} = {}){
  if (!ACTIVE_LIB) return;

  const track = ACTIVE_LIB.tracks[code];
  if (!track) { alert("Track not found in this library."); return; }

  ACTIVE_CODE = code;

  // Sync dropdown (if code exists)
  if (trackSelectEl && trackSelectEl.value !== code) {
    // only set if option exists; otherwise keep as-is
    const has = Array.from(trackSelectEl.options).some(o => o.value === code);
    if (has) trackSelectEl.value = code;
  }

  const title = safeText(track.title) || "Untitled";
  const dur = track.duration ? ` (${track.duration})` : "";
  nowPlayingEl.textContent = `${code} — ${title}${dur}`;

  setPlayerSources(track);
  playerEl.load();

  // Prepend a header into notes (only once per session, per track selection)
  const header = `Library: ${ACTIVE_LIB.name}\nTrack: ${code} — ${title}${dur}\n`;
  if (!fbEl.value.startsWith("Library:")) {
    fbEl.value = header + "\n" + (fbEl.value || "");
  } else {
    // If notes already have a header, add a separator with new track line
    fbEl.value = header + "\n" + fbEl.value;
  }
  fbEl.focus();

  if (autoplay) {
    playerEl.play().catch(()=>{ /* user gesture may be required */ });
  }
}

// ===== 8) FEEDBACK TOOLS =====
function insertTimestamp(){
  const ts = formatTime(playerEl.currentTime || 0);
  insertAtCursor(fbEl, `${ts} - `);
}

async function copyFB(){
  const v = (fbEl.value || "").trim();
  if (!v) { alert("No feedback yet."); return; }
  try{
    await navigator.clipboard.writeText(v);
    alert("Feedback copied. Paste it back to me.");
  }catch(e){
    fbEl.select();
    document.execCommand("copy");
    alert("Feedback copied. Paste it back to me.");
  }
}

async function copyTrackLine(){
  if (!ACTIVE_LIB || !ACTIVE_CODE) { alert("No track selected."); return; }
  const t = ACTIVE_LIB.tracks[ACTIVE_CODE];
  const title = safeText(t.title) || "Untitled";
  const dur = t.duration ? ` (${t.duration})` : "";
  const line = `${ACTIVE_CODE} — ${title}${dur}`;
  try{
    await navigator.clipboard.writeText(line);
    alert("Track line copied.");
  }catch(e){
    alert("Copy failed. Please copy manually:\n" + line);
  }
}

function resetNotes(){
  fbEl.value = "";
  fbEl.focus();
}

// Keyboard shortcuts inside textarea:
// - T => insert timestamp
// - Ctrl/Cmd + Enter => copy feedback
fbEl.addEventListener("keydown", (ev)=>{
  if (!ev.ctrlKey && !ev.metaKey && ev.key.toLowerCase() === "t") {
    ev.preventDefault();
    insertTimestamp();
  }
  if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") {
    ev.preventDefault();
    copyFB();
  }
});

// Also allow global T if textarea is focused (already handled), keep global clean.

// ===== 9) OPTIONAL: auto-focus passcode on load =====
window.addEventListener("load", ()=> { pwEl.focus(); });
</script>

</body>
</html>

