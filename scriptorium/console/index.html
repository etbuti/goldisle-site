<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Scriptorium · Console</title>

<meta name="robots" content="noindex,nofollow,noarchive,nosnippet" />
<meta name="referrer" content="same-origin" />

<link rel="stylesheet" href="/scriptorium/assets/rr.css" />
</head>

<body>

<header class="top">
  <div>
    <div class="kicker">SCRIPTORIUM</div>
    <div class="toprow">
      <h1 class="h">Console</h1>
      <div class="count" id="console-count">·</div>
      <div class="status">internal</div>
    </div>
    <div class="sub">Archive internal tools · curator workspace</div>
  </div>
</header>

<main class="wrap wide">
<section class="panel">

  <div class="row">
    <input class="input" id="q" placeholder="Search name / tag / note…" />
    <select class="select" id="group"></select>
    <select class="select" id="tag"></select>

    <a class="input"
       style="display:inline-block;text-decoration:none"
       href="/scriptorium/room.html">
       ← Shelves
    </a>
  </div>

  <div id="grid" class="grid"></div>

</section>

<footer class="foot">
Scriptorium internal console.<br>
Edit <span class="mono">/scriptorium/console/links.json</span> to manage entries.
</footer>
</main>

<script>
(async function(){

const grid = document.getElementById("grid");
const qEl  = document.getElementById("q");
const gEl  = document.getElementById("group");
const tEl  = document.getElementById("tag");
const countEl = document.getElementById("console-count");

let data = {items:[]};

function esc(s){
  return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function norm(s){return (s||"").toLowerCase().trim();}
function uniq(a){return Array.from(new Set(a.filter(Boolean))).sort((a,b)=>a.localeCompare(b));}

function render(items){

  countEl.textContent = items.length + " items";

  grid.innerHTML="";

  for(const it of items){

    const card=document.createElement("div");
    card.className="panel";

    const tags=(it.tags||[]).slice(0,6).map(t=>`<span class="status">${esc(t)}</span>`).join("");

    const links=(it.links||[]).map(a=>`
      <a class="input"
         style="display:inline-block;text-decoration:none"
         href="${esc(a.href||"#")}"
         target="_blank"
         rel="noreferrer">
         ${esc(a.label||"Open")} →
      </a>
    `).join("");

    card.innerHTML=`
      <div class="kicker">${esc(it.group||"PROJECT")}</div>
      <div class="toprow">
        <div class="h" style="font-size:18px">${esc(it.name||"Untitled")}</div>
        ${it.pinned?`<div class="status">PIN</div>`:""}
      </div>
      <div class="sub" style="margin-top:6px">${esc(it.desc||"")}</div>
      <div class="row" style="margin-top:8px">${tags}</div>
      <div class="row" style="margin-top:10px;flex-wrap:wrap;gap:8px">${links}</div>
    `;

    grid.appendChild(card);
  }
}

function apply(){

  let items=data.items||[];

  const q=norm(qEl.value);
  const g=gEl.value;
  const t=tEl.value;

  if(g) items=items.filter(x=>x.group===g);
  if(t) items=items.filter(x=>(x.tags||[]).includes(t));

  if(q){
    items=items.filter(x=>{
      const hay=[x.name,x.desc,x.group,...(x.tags||[])].join(" ");
      return norm(hay).includes(q);
    });
  }

  items=[...items].sort((a,b)=>{
    if(!!a.pinned!==!!b.pinned) return a.pinned?-1:1;
    return String(a.name||"").localeCompare(String(b.name||""));
  });

  render(items);
}

try{
  const res=await fetch("./links.json",{cache:"no-store"});
  data=await res.json();
}catch(e){
  grid.innerHTML='<div class="sub">Cannot load links.json</div>';
  return;
}

gEl.innerHTML='<option value="">All groups</option>'+uniq((data.items||[]).map(x=>x.group))
  .map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");

tEl.innerHTML='<option value="">All tags</option>'+uniq((data.items||[]).flatMap(x=>x.tags||[]))
  .map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");

qEl.addEventListener("input",apply);
gEl.addEventListener("change",apply);
tEl.addEventListener("change",apply);

apply();

})();
</script>

</body>
</html>
